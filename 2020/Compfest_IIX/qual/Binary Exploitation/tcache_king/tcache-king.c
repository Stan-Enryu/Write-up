#include<stdio.h>
#include<stdlib.h>

char *name;
char *notes[100];

void print_menu()    {
    puts("=====ABC Notes=====");
    puts("1. Add Note");
    puts("2. Delete Note");
    puts("3. Print Note");
    puts("4. Change username");
    puts("5. Exit");
    puts("===================");
    printf("Choice: ");
}

int my_read(char* buf, int size)    {
    int count;
    count = read(0, buf, size);
    if(count == -1)    {
        puts("Read Error");
        exit(-1);
    }
    if(buf[count-1] == '\n')    {
        buf[count-1] = '\0';
    }
    return count;
}

uint read_uint()    {
    char num[5];
    my_read(num, 5);
    return atoi(num);
}

void check_alphanumeric_note(char *note, int size)    {
    for(int i = 0; i < size; i++)    {
        if((note[i] < 0x30 || (note[i] > 0x39 && note[i] < 0x41) || (note[i] > 0x5a && note[i] < 0x61) || note[i] > 0x7a) && note[i] != 0 && note[i] != 0x20)    {
            puts("Only Alphanumeric notes allowed!");
            exit(-1);
        }
    }
}

void add_note()    {
    uint index, size;
    char *new_note;    
    printf("Enter note index: ");
    index = read_uint();
    if(index > 99)    {
        puts("Note index too large!");
        return;
    }
    printf("Enter note size: ");
    size = read_uint();
    if(size > 0x350)    {
        puts("Note size too large!");
        return;
    }
    new_note = malloc(size);
    printf("Enter note contents: ");
    uint count = my_read(new_note, size);
    check_alphanumeric_note(new_note, count);
    notes[index] = new_note;
    puts("Note added!\n");
}

void delete_note()    {
    uint index;
    printf("Enter note index: ");
    index = read_uint();
    if(index > 99)    {
        puts("Note index too large!");
        return;
    }
    free(notes[index]);
    puts("Note deleted!\n");
}

void print_note()    {
    puts("Todo: Create printing function");
    puts("Probset note: No, this is not a mistake this is intentional");
}

void change_name()    {
    printf("Enter username: ");
    name = malloc(0x40);
    my_read(name, 0x40);
}

int main(int argc, char const *argv[])
{
    setvbuf(stdout, NULL, _IONBF, 0);
    change_name();
    uint choice;
    while(1)    {
        print_menu();
        choice = read_uint();
        switch(choice)    {
            case 1:
                add_note();
                break;
            case 2:
                delete_note();
                break;
            case 3:
                print_note();
                break;
            case 4:
                change_name();
                break;
            case 5:
                printf("Goodbye %s!\n", name);
                exit(0);
                break;
            default:
                puts("Unknown Command");
                break;
        }
    }
    return 0;
}